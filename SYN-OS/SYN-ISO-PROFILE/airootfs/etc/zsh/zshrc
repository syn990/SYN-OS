#!/bin/zsh
# =============================================================================
#                             SYN-OS .zshrc
#       Live ISO Environment Configuration & Installation Splash Screen
# -----------------------------------------------------------------------------
#   Branded Zsh setup for the SYN-OS live environment. Provides system info,
#   installer hints, custom prompt, and useful defaults. Fast and self-contained.
#   Author: William Hayward-Holland (Syntax990)
#   License: MIT
# =============================================================================

# Only clear and render splash for interactive TTYs
if [[ -o interactive && -t 1 ]]; then
  clear
fi

# =============================================================================
# Live Environment Notice (Gap 1) + Install Model (Gap 3)
# =============================================================================
if [[ -o interactive && -t 1 ]]; then
  printf "\n\033[1;36m[SYN-OS Live]\033[0m This is a \033[1mtemporary\033[0m installer shell, not your final system.\n"
  printf "Use it to \033[1medit config\033[0m and then run the installer.\n"

  printf "\n\033[1;36m[Install Model]\033[0m\n"
  printf "  • \033[1msyntax990\033[0m runs \033[1msyn-stage0.zsh\033[0m (pre-chroot): disk prep, pacstrap, arch-chroot.\n"
  printf "  • \033[1msyn-stage1.zsh\033[0m runs \033[1mautomatically inside arch-chroot\033[0m.\n"
  printf "  • \033[31mDo NOT run stage1 manually\033[0m — stage0 invokes it in the correct context.\n"
fi

# =============================================================================
# System Information and Checks
# =============================================================================
if curl -fsSIL --max-time 2 https://archlinux.org >/dev/null 2>&1; then
  printf "\n\033[1;32m[OK] Internet connection detected.\033[0m\n"
else
  printf "\n\033[1;31m[Warning] No internet connection detected.\033[0m\n"
  printf "   - Connect Ethernet or use: \033[35miwctl\033[0m for Wi‑Fi\n"
  printf "   - For WWAN modems: \033[35mmmcli\033[0m\n"
fi

# =============================================================================
#   WARNING: RUNNING 'syntax990' WILL ERASE YOUR DATA
# =============================================================================
printf "\n\033[1;41m WARNING: RUNNING 'syntax990' WILL ERASE YOUR DATA \033[0m\n"
printf "\033[1;31mReview and edit install parameters before running.\033[0m\n"
printf "Failure to do so will result in total data loss.\n"
printf "\n\033[1;33mEdit these before proceeding:\033[0m\n"
printf "   \033[35mnano /etc/syn-os/synos.conf\033[0m\n"

confirm_syntax990() {
  printf "\n\033[1;41m DANGER \033[0m This will erase target disks configured in syn-stage scripts.\n"
  printf "Type \033[1msyntax990 YES\033[0m to proceed: "
  read -r a b
  if [[ "$a $b" == "syntax990 YES" ]]; then
    /usr/lib/syn-os/syn-stage0.zsh
  else
    printf "Aborted.\n"
  fi
}

# =============================================================================
# SYN‑OS Structure
# =============================================================================
printf "\n\033[1;36m[SYN‑OS Structure]\033[0m\n"
printf "  • Scripts: /usr/lib/syn-os/\n"
printf "  • Configuration: /etc/syn-os/\n"
printf "  • Overlays will be installed to the target system during install.\n"

# =============================================================================
# Installation
# =============================================================================
printf "\n\033[1;33m[Install]\033[0m Run \033[38;2;23;147;209msyntax990\033[0m to start the installer.\n"

# =============================================================================
# Environment
# =============================================================================
export LANG=en_GB.UTF-8
export EDITOR='nano'

# XDG paths (cleaner FS layout)
: "${XDG_CACHE_HOME:=${HOME}/.cache}"
: "${XDG_STATE_HOME:=${HOME}/.local/state}"

# =============================================================================
# Zsh Options
# =============================================================================
setopt prompt_subst
setopt interactivecomments
setopt nocaseglob
setopt nomatch
setopt path_dirs
unsetopt beep

# History behaviour
setopt appendhistory sharehistory inc_append_history
setopt hist_ignore_space hist_reduce_blanks hist_verify
setopt histignorealldups extended_history

# Completion behaviour
setopt complete_in_word auto_menu

# =============================================================================
# History
# =============================================================================
HISTDIR="${XDG_STATE_HOME}/zsh"
mkdir -p "$HISTDIR"
HISTFILE="${HISTDIR}/history"
HISTSIZE=50000
SAVEHIST=50000

# =============================================================================
# Completion (interactive menu + colours)
# =============================================================================
autoload -Uz compinit bashcompinit
zmodload -i zsh/complist

ZSH_CACHE="${XDG_CACHE_HOME}/zsh"
mkdir -p "$ZSH_CACHE"

# -i: insecure dirs ok in live env, -C: skip function check for speed
compinit -i -C -d "${ZSH_CACHE}/zcompdump"

# Interactive menu UI like OMZ
zstyle ':completion:*' menu select
zstyle ':completion:*' list-colors ''
zstyle ':completion:*:*:*:*:descriptions' format '%F{blue}-- %d --%f'
# Case-insensitive + smart matching for dots/underscores/hyphens
zstyle ':completion:*' matcher-list 'm:{a-z}={A-Za-z}' 'r:|[._-]=* r:|=*'
zstyle ':completion:*' squeeze-slashes true

# Reverse Shift-Tab in menu
bindkey -M menuselect '^[[Z' reverse-menu-complete

# =============================================================================
# Keybinds (Foot-safe; fix Delete, Home/End, Ctrl+Delete, Backspace-word)
# =============================================================================
bindkey -e
bindkey '^H' backward-kill-word               # Ctrl+Backspace on many layouts
bindkey '^[[3;5~' kill-word                   # Ctrl+Delete → kill word
bindkey '^[[3~' delete-char                   # Delete
bindkey '^[[H' beginning-of-line              # Home
bindkey '^[[F' end-of-line                    # End

# =============================================================================
# Tools
# =============================================================================
if command -v fzf >/dev/null 2>&1; then
  [[ -r /usr/share/fzf/completion.zsh   ]] && source /usr/share/fzf/completion.zsh
  [[ -r /usr/share/fzf/key-bindings.zsh ]] && source /usr/share/fzf/key-bindings.zsh
  # Nice defaults for fzf
  export FZF_DEFAULT_OPTS="--height 40% --layout=reverse --border"
fi

if command -v zoxide >/dev/null 2>&1; then
  eval "$(zoxide init zsh)"
fi

# Plugins: autosuggestions before syntax highlighting
[[ -r /usr/share/zsh/plugins/zsh-autosuggestions/zsh-autosuggestions.zsh       ]] && \
  source /usr/share/zsh/plugins/zsh-autosuggestions/zsh-autosuggestions.zsh
[[ -r /usr/share/zsh/plugins/zsh-syntax-highlighting/zsh-syntax-highlighting.zsh ]] && \
  source /usr/share/zsh/plugins/zsh-syntax-highlighting/zsh-syntax-highlighting.zsh

# =============================================================================
# Aliases
# =============================================================================
alias syntax990="/usr/lib/syn-os/syn-stage0.zsh"
alias ll='ls -lah'
alias la='ls -A'
alias l='ls -CF'

command -v bat >/dev/null 2>&1 && alias cat='bat --paging=never'
command -v rg  >/dev/null 2>&1 && alias grep='rg'

mkcd() { mkdir -p -- "$1" && builtin cd -- "$1"; }

# =============================================================================
# Prompt & VCS
# =============================================================================
autoload -Uz vcs_info
precmd() { vcs_info }

zstyle ':vcs_info:*' enable git
zstyle ':vcs_info:git:*' formats '%F{cyan}(%b%u%c)%f'
zstyle ':vcs_info:git:*' actionformats '%F{cyan}(%b|%a)%f'

# Left prompt: user@host + cwd + git + brackets
PROMPT='%F{blue}[%f%F{red}%n@%m%f %F{160}%~%f${vcs_info_msg_0_} %F{blue}]%f %# '
# Right prompt: time + status (✔/✘ + code)
RPROMPT='%F{white}%D{%H:%M:%S}%f %(?..%F{red}✘%?%f:%F{green}✔%f)'

# =============================================================================
# One line MOTD
# =============================================================================
if [[ -o interactive && -t 1 && -z ${SYN_MOTD_SHOWN} ]]; then
  export SYN_MOTD_SHOWN=1
  print -P "[SYN-OS Live] Zsh ready. Type 'syntax990' to start the installer."
fi